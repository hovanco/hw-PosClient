{"ast":null,"code":"import axios from 'axios';\nimport queryString from 'query-string';\nimport authApi from '../api/auth-api';\nimport constants from '../constants';\nimport { checkToken, getToken, getTokenLocal, removeToken, setToken } from './token';\nconst axiosClient = axios.create({\n  baseURL: constants.URL_API,\n  headers: {\n    'content-type': 'application/json'\n  },\n  paramsSerializer: params => queryString.stringify(params)\n});\naxiosClient.interceptors.request.use(config => {\n  const accessToken = getToken('accessToken');\n\n  if (accessToken) {\n    config.headers['Authorization'] = 'Bearer ' + accessToken;\n  }\n\n  return config;\n});\naxiosClient.interceptors.response.use(response => {\n  if (response && response.data) {\n    return response.data;\n  }\n\n  return response;\n}, async error => {\n  const originalRequest = error.config;\n\n  if (error.response.status === 401 && !originalRequest._retry) {\n    const refreshToken = getToken('refreshToken');\n\n    if (refreshToken) {\n      const isValidRefreshToken = checkToken(refreshToken);\n\n      if (!isValidRefreshToken) {\n        removeToken();\n        return Promise.reject(error);\n      }\n\n      try {\n        const response = await authApi.refreshAccessToken(refreshToken);\n        const {\n          accessToken\n        } = response;\n        const tokenLocal = getTokenLocal();\n        setToken({\n          token: { ...tokenLocal,\n            accessToken\n          },\n          remember: true\n        });\n        originalRequest._retry = true;\n        axios.defaults.headers.common['Authorization'] = `Bearer ${accessToken}`;\n        return axiosClient(originalRequest);\n      } catch (err) {\n        if (err.response.status === 401) {\n          removeToken();\n        }\n\n        return Promise.reject(err);\n      }\n    }\n\n    return Promise.reject(error);\n  }\n\n  return Promise.reject(error);\n});\nexport default axiosClient;","map":{"version":3,"sources":["/Users/mac3/Desktop/workspace/PosClient/src/api/axios-client.ts"],"names":["axios","queryString","authApi","constants","checkToken","getToken","getTokenLocal","removeToken","setToken","axiosClient","create","baseURL","URL_API","headers","paramsSerializer","params","stringify","interceptors","request","use","config","accessToken","response","data","error","originalRequest","status","_retry","refreshToken","isValidRefreshToken","Promise","reject","refreshAccessToken","tokenLocal","token","remember","defaults","common","err"],"mappings":"AAAA,OAAOA,KAAP,MAAkB,OAAlB;AACA,OAAOC,WAAP,MAAwB,cAAxB;AACA,OAAOC,OAAP,MAAoB,iBAApB;AACA,OAAOC,SAAP,MAAsB,cAAtB;AACA,SAASC,UAAT,EAAqBC,QAArB,EAA+BC,aAA/B,EAAsDC,WAAtD,EAAmEC,QAAnE,QAAmF,SAAnF;AAEA,MAAMC,WAAW,GAAGT,KAAK,CAACU,MAAN,CAAa;AAC7BC,EAAAA,OAAO,EAAER,SAAS,CAACS,OADU;AAE7BC,EAAAA,OAAO,EAAE;AACL,oBAAgB;AADX,GAFoB;AAK7BC,EAAAA,gBAAgB,EAAGC,MAAD,IAAYd,WAAW,CAACe,SAAZ,CAAsBD,MAAtB;AALD,CAAb,CAApB;AAQAN,WAAW,CAACQ,YAAZ,CAAyBC,OAAzB,CAAiCC,GAAjC,CAAsCC,MAAD,IAAY;AAC7C,QAAMC,WAAW,GAAGhB,QAAQ,CAAC,aAAD,CAA5B;;AAEA,MAAIgB,WAAJ,EAAiB;AACbD,IAAAA,MAAM,CAACP,OAAP,CAAe,eAAf,IAAkC,YAAYQ,WAA9C;AACH;;AACD,SAAOD,MAAP;AACH,CAPD;AASAX,WAAW,CAACQ,YAAZ,CAAyBK,QAAzB,CAAkCH,GAAlC,CACKG,QAAD,IAAc;AACV,MAAIA,QAAQ,IAAIA,QAAQ,CAACC,IAAzB,EAA+B;AAC3B,WAAOD,QAAQ,CAACC,IAAhB;AACH;;AAED,SAAOD,QAAP;AACH,CAPL,EAQI,MAAOE,KAAP,IAAiB;AACb,QAAMC,eAAe,GAAGD,KAAK,CAACJ,MAA9B;;AAEA,MAAII,KAAK,CAACF,QAAN,CAAeI,MAAf,KAA0B,GAA1B,IAAiC,CAACD,eAAe,CAACE,MAAtD,EAA8D;AAC1D,UAAMC,YAAY,GAAGvB,QAAQ,CAAC,cAAD,CAA7B;;AAEA,QAAIuB,YAAJ,EAAkB;AACd,YAAMC,mBAAmB,GAAGzB,UAAU,CAACwB,YAAD,CAAtC;;AAEA,UAAI,CAACC,mBAAL,EAA0B;AACtBtB,QAAAA,WAAW;AACX,eAAOuB,OAAO,CAACC,MAAR,CAAeP,KAAf,CAAP;AACH;;AAED,UAAI;AACA,cAAMF,QAAQ,GAAG,MAAMpB,OAAO,CAAC8B,kBAAR,CAA2BJ,YAA3B,CAAvB;AACA,cAAM;AAAEP,UAAAA;AAAF,YAAkBC,QAAxB;AAEA,cAAMW,UAAU,GAAG3B,aAAa,EAAhC;AAEAE,QAAAA,QAAQ,CAAC;AACL0B,UAAAA,KAAK,EAAE,EACH,GAAID,UADD;AAEHZ,YAAAA;AAFG,WADF;AAKLc,UAAAA,QAAQ,EAAE;AALL,SAAD,CAAR;AAQAV,QAAAA,eAAe,CAACE,MAAhB,GAAyB,IAAzB;AAEA3B,QAAAA,KAAK,CAACoC,QAAN,CAAevB,OAAf,CAAuBwB,MAAvB,CAA8B,eAA9B,IAAkD,UAAShB,WAAY,EAAvE;AAEA,eAAOZ,WAAW,CAACgB,eAAD,CAAlB;AACH,OAnBD,CAmBE,OAAOa,GAAP,EAAY;AACV,YAAIA,GAAG,CAAChB,QAAJ,CAAaI,MAAb,KAAwB,GAA5B,EAAiC;AAC7BnB,UAAAA,WAAW;AACd;;AAED,eAAOuB,OAAO,CAACC,MAAR,CAAeO,GAAf,CAAP;AACH;AACJ;;AAED,WAAOR,OAAO,CAACC,MAAR,CAAeP,KAAf,CAAP;AACH;;AAED,SAAOM,OAAO,CAACC,MAAR,CAAeP,KAAf,CAAP;AACH,CAtDL;AAyDA,eAAef,WAAf","sourcesContent":["import axios from 'axios';\nimport queryString from 'query-string';\nimport authApi from '../api/auth-api';\nimport constants from '../constants';\nimport { checkToken, getToken, getTokenLocal, IToken, removeToken, setToken } from './token';\n\nconst axiosClient = axios.create({\n    baseURL: constants.URL_API,\n    headers: {\n        'content-type': 'application/json',\n    },\n    paramsSerializer: (params) => queryString.stringify(params),\n});\n\naxiosClient.interceptors.request.use((config) => {\n    const accessToken = getToken('accessToken');\n\n    if (accessToken) {\n        config.headers['Authorization'] = 'Bearer ' + accessToken;\n    }\n    return config;\n});\n\naxiosClient.interceptors.response.use(\n    (response) => {\n        if (response && response.data) {\n            return response.data;\n        }\n\n        return response;\n    },\n    async (error) => {\n        const originalRequest = error.config;\n\n        if (error.response.status === 401 && !originalRequest._retry) {\n            const refreshToken = getToken('refreshToken');\n\n            if (refreshToken) {\n                const isValidRefreshToken = checkToken(refreshToken);\n\n                if (!isValidRefreshToken) {\n                    removeToken();\n                    return Promise.reject(error);\n                }\n\n                try {\n                    const response = await authApi.refreshAccessToken(refreshToken);\n                    const { accessToken } = response;\n\n                    const tokenLocal = getTokenLocal();\n\n                    setToken({\n                        token: {\n                            ...(tokenLocal as IToken),\n                            accessToken,\n                        },\n                        remember: true,\n                    });\n\n                    originalRequest._retry = true;\n\n                    axios.defaults.headers.common['Authorization'] = `Bearer ${accessToken}`;\n\n                    return axiosClient(originalRequest);\n                } catch (err) {\n                    if (err.response.status === 401) {\n                        removeToken();\n                    }\n\n                    return Promise.reject(err);\n                }\n            }\n\n            return Promise.reject(error);\n        }\n\n        return Promise.reject(error);\n    }\n);\n\nexport default axiosClient;\n"]},"metadata":{},"sourceType":"module"}